# 小红书自动发布系统 (xiaohongshu-mcp) 完整说明

## 目录

- [系统概述](#系统概述)
- [核心功能](#核心功能)
- [技术架构](#技术架构)
- [MCP 服务清单](#mcp-服务清单)
- [安装和部署](#安装和部署)
- [使用配置](#使用配置)
- [Claude Code 使用示例](#claude-code-使用示例)
- [技术特点](#技术特点)
- [注意事项](#注意事项)
- [故障排除和FAQ](#故障排除和faq)
- [AI 图片生成配置](#ai-图片生成配置)
- [扩展能力](#扩展能力)
- [总结](#总结)
- [版本信息](#版本信息)
- [贡献指南](#贡献指南)
- [许可证](#许可证)
- [联系方式](#联系方式)

## 系统概述

这是一个基于 Go 语言开发的小红书自动化发布系统，通过 MCP (Model Context Protocol) 协议为 Claude Code 等 AI 客户端提供自动发布小红书图文内容的能力。系统采用无头浏览器技术，模拟真实用户操作，实现自动化登录、发布、搜索、获取内容等功能。

**核心特色**：集成了阿里云 Qwen 文生图功能，当找不到合适图片时，可以通过 AI 自动生成高质量的配图，真正实现从内容构思到发布的全自动化流程。

## 核心功能

### 1. 登录管理
- **自动登录检测**: 检查当前小红书登录状态
- **状态保持**: 自动保存和恢复登录 Cookie
- **手动登录支持**: 提供独立的登录程序 (`cmd/login/main.go`)

### 2. 内容发布
- **图文发布**: 支持标题、正文描述、多张图片和标签的完整发布
- **图片处理**:
  - 支持本地图片路径
  - 支持 URL 图片自动下载
  - 自动文件类型检测
- **标题限制**: 自动检测标题长度（最大40个单位，中文2个单位，英文1个单位）
- **标签支持**: 自动添加话题标签，支持联想选择

### 3. AI 图片生成 MCP 服务 (Qwen 文生图)
- **独立 MCP 服务**: `qwen_image_mcp.py` 作为标准的 MCP 服务，符合协议规范
- **智能图片生成**: 基于阿里云 Qwen 模型，根据文本描述生成高质量图片
- **多风格支持**: 提供 14 种预设风格（生活方式、美食、时尚、旅行、美妆、科技、艺术等）
- **平台优化**: 针对小红书等平台的图片尺寸和风格进行优化
- **参数化配置**: 所有生成参数通过 MCP 工具调用时动态指定，无硬编码预设
- **增强功能**: 自动优化提示词，添加摄影术语、光线描述和质量关键词
- **本地保存**: 自动下载并保存生成的图片到本地

### 4. 内容获取
- **推荐列表**: 获取小红书首页推荐内容
- **搜索功能**: 根据关键词搜索相关内容
- **详情获取**: 获取帖子完整详情，包括互动数据和评论
- **评论功能**: 自动发表评论到指定帖子

## 技术架构

### 系统组件

```
xiaohongshu-mcp/
├── main.go                      # 应用入口
├── service.go                   # 业务服务层
├── types.go                     # 数据类型定义
├── mcp_handlers.go             # MCP 协议处理器
├── handlers_api.go             # HTTP API 处理器
├── streamable_http.go          # MCP HTTP 服务器
├── qwen_image_mcp.py           # AI 图片生成 MCP 服务 (Python)
├── run_qwen_mcp.py             # MCP 服务启动脚本
├── universal_qwen_generator_backup.py # 原生成器备份
├── qwen_env/                   # Python 虚拟环境目录
│   ├── bin/                    # 可执行文件 (Linux/macOS)
│   ├── Scripts/                # 可执行文件 (Windows)
│   ├── lib/                    # Python 包库
│   │   └── python3.x/
│   │       └── site-packages/  # 安装的 Python 包
│   │           ├── dashscope/  # 阿里云 SDK
│   │           └── requests/   # HTTP 请求库
│   └── pyvenv.cfg              # 虚拟环境配置
├── generated_images/           # AI 生成图片存储目录
├── xiaohongshu/                # 小红书核心模块
│   ├── types.go                # 数据结构定义
│   ├── login.go                # 登录功能
│   ├── publish.go              # 发布功能
│   ├── feeds.go                # 推荐列表
│   ├── search.go               # 搜索功能
│   ├── feed_detail.go          # 详情获取
│   ├── comment_feed.go         # 评论功能
│   └── navigate.go             # 页面导航
├── browser/                    # 浏览器模块
├── configs/                    # 配置管理
├── pkg/downloader/             # 图片下载器
│   ├── images.go               # 图片下载核心
│   ├── processor.go            # 图片处理器
│   └── images_test.go          # 测试文件
└── cmd/login/                  # 独立登录程序
```

### 关键技术

1. **无头浏览器**: 基于 `go-rod` 库，支持 Chrome/Chromium 自动化
2. **MCP 协议**: 实现 Model Context Protocol，与 AI 客户端通信
3. **HTTP 服务**: 提供 REST API 和 MCP over HTTP 服务
4. **AI 图片生成 MCP 服务**: 独立的阿里云 DashScope Qwen 文生图 MCP 服务
5. **图片处理**: 支持多种图片格式、URL 下载和 AI 生成图片
6. **DOM 操作**: 精确的页面元素定位和交互
7. **多语言集成**: Go 后端 + Python MCP 图片生成服务

## MCP 服务清单

### 1. 小红书主服务 (xiaohongshu-mcp)
端口: 18060，提供 6 个 MCP 工具：

| 工具名称 | 功能描述 | 参数 |
|---------|---------|------|
| `check_login_status` | 检查登录状态 | 无 |
| `publish_content` | 发布图文内容 | title, content, images, tags |
| `list_feeds` | 获取推荐列表 | 无 |
| `search_feeds` | 搜索内容 | keyword |
| `get_feed_detail` | 获取帖子详情 | feed_id, xsec_token |
| `post_comment_to_feed` | 发表评论 | feed_id, xsec_token, content |

### 2. Qwen 图片生成服务 (qwen-image-mcp)
独立 MCP 服务，提供 4 个工具：

| 工具名称 | 功能描述 | 主要参数 |
|---------|---------|------|
| `generate_image` | 生成高质量图片 | prompt, style, platform, size, api_key |
| `list_styles` | 获取所有可用风格 | 无 |
| `list_platforms` | 获取所有支持平台 | 无 |
| `get_style_info` | 获取风格详细信息 | style |

## 安装和部署

### 快速开始

1. **克隆项目**
```bash
git clone https://github.com/your-org/xiaohongshu-mcp.git
cd xiaohongshu-mcp
```

2. **安装 Go 依赖**
```bash
go mod tidy
```

3. **设置 Python 环境（用于图片生成）**
```bash
# 在项目根目录创建虚拟环境
python3 -m venv qwen_env

# 激活虚拟环境
source qwen_env/bin/activate  # Linux/macOS
# 或 Windows: qwen_env\Scripts\activate

# 安装依赖
pip install dashscope requests
```

**注意**: 虚拟环境 `qwen_env/` 会在项目根目录下创建，包含所有Python依赖。

4. **配置环境变量**
```bash
# 设置阿里云 DashScope API Key（用于图片生成）
export DASHSCOPE_API_KEY="your-api-key"
```

5. **启动服务**
```bash
# 启动小红书主服务
go run . -headless=true

# 在另一个终端启动图片生成服务（可选）
source qwen_env/bin/activate && python3 run_qwen_mcp.py
```

## 使用配置

### 环境要求
- Go 1.21.0+
- Python 3.8+ (用于 AI 图片生成)
- Chrome/Chromium 浏览器
- 网络连接
- 阿里云 DashScope API Key (可选，用于 AI 图片生成)

### 启动参数
```bash
go run . [选项]
  -headless=true     # 无头模式（默认）
  -headless=false    # 有界面模式
  -bin="path"        # 指定浏览器路径
```

### MCP 客户端接入

#### Claude Code CLI
```bash
# 添加小红书主服务
claude mcp add --transport http xiaohongshu-mcp http://localhost:18060/mcp

# 添加 Qwen 图片生成服务
# 注意：需要使用虚拟环境中的Python解释器
claude mcp add --transport stdio qwen-image-mcp /path/to/xiaohongshu-mcp/qwen_env/bin/python /path/to/xiaohongshu-mcp/run_qwen_mcp.py
```

#### Cursor 配置
创建 `.cursor/mcp.json`:
```json
{
  "mcpServers": {
    "xiaohongshu-mcp": {
      "url": "http://localhost:18060/mcp",
      "description": "小红书内容发布服务"
    },
    "qwen-image-mcp": {
      "command": "/path/to/xiaohongshu-mcp/qwen_env/bin/python",
      "args": ["/path/to/xiaohongshu-mcp/run_qwen_mcp.py"],
      "description": "阿里云 Qwen 图片生成服务"
    }
  }
}
```

#### VSCode 配置
创建 `.vscode/mcp.json`:
```json
{
  "servers": {
    "xiaohongshu-mcp": {
      "url": "http://localhost:18060/mcp",
      "type": "http"
    },
    "qwen-image-mcp": {
      "command": "/path/to/xiaohongshu-mcp/qwen_env/bin/python",
      "args": ["/path/to/xiaohongshu-mcp/run_qwen_mcp.py"],
      "type": "stdio"
    }
  }
}
```

## Claude Code 使用示例

### 1. 检查登录状态
```
请检查小红书登录状态
```

### 2. 发布图文内容
```
帮我发布一篇小红书图文：
- 标题：今日分享
- 内容：这是一篇测试内容
- 图片：https://example.com/image.jpg
- 标签：生活,分享,日常
```

### 3. 搜索相关内容
```
搜索小红书上关于"美食"的内容
```

### 4. 获取帖子详情
```
获取这个帖子的详细信息：feed_id=123456, xsec_token=abc123
```

### 5. AI 生成图片并发布
```
帮我生成一张美食图片并发布小红书：
- 图片描述：精致的日式料理摆盘
- 标题：今日料理分享
- 内容：分享一下今天制作的日式料理，摆盘很用心哦
- 标签：美食,日料,摆盘
```

### 6. 发表评论
```
在帖子上发表评论：
- feed_id: 123456
- xsec_token: abc123
- 评论内容: 很棒的分享！
```

### 7. 独立使用 Qwen 图片生成服务
```
使用 Qwen 生成一张小红书风格的图片：
- 提示词：温馨的午后咖啡时光
- 风格：lifestyle
- 平台：xiaohongshu
- 尺寸：1472*1140
```

## 技术特点

### 1. 智能DOM定位
- 多种策略查找页面元素
- 支持动态内容加载等待
- 容错处理机制

### 2. AI 图片生成能力
- **14种预设风格**: general, lifestyle, food, fashion, travel, beauty, tech, art, traditional, business, nature, portrait, abstract, cartoon
- **平台优化**: 针对小红书、微博、抖音等平台的尺寸和风格优化
- **智能提示词增强**: 自动添加摄影术语、光线描述、质量关键词
- **批量生成**: 支持一次生成多张不同风格的图片
- **本地保存**: 自动下载保存，支持自定义文件名和目录

### 3. 图片处理能力
- 自动下载网络图片
- 支持多种图片格式检测
- AI 生成图片自动集成
- 临时文件自动清理

### 4. 标签智能处理
- 自动添加 # 前缀
- 支持联想选择
- 智能输入策略

### 5. 错误处理
- 完善的错误信息
- 超时保护机制
- 重试策略

## 注意事项

### 运营限制
- 小红书标题限制：20个字以内
- 每日发帖建议：50篇以内
- 同一账号不能多地登录

### 技术限制
- 需要稳定网络连接
- 依赖浏览器环境
- 受小红书页面结构变化影响

### 安全考虑
- 请勿用于违法用途
- 注意账号安全
- 遵守平台规则

## 故障排除和FAQ

### 常见问题

#### Q1: 启动时提示"缺少依赖库"
**解决方案**:
```bash
# 对于Go依赖
go mod tidy

# 对于Python依赖，确保在虚拟环境中安装
cd /path/to/xiaohongshu-mcp
source qwen_env/bin/activate  # 激活虚拟环境
pip install dashscope requests
```

**注意**: Python依赖必须安装在 `qwen_env/` 虚拟环境中，而不是系统全局环境。

#### Q2: 图片生成失败，提示API密钥错误
**解决方案**:
1. 检查API密钥是否正确设置
2. 确认阿里云DashScope账户余额充足
3. 验证网络连接是否正常

#### Q3: 小红书登录失败
**解决方案**:
1. 尝试手动登录程序：`go run cmd/login/main.go`
2. 清除浏览器缓存和Cookie
3. 检查网络连接是否稳定

#### Q4: 发布内容后找不到帖子
**解决方案**:
1. 等待5-10分钟，平台可能有审核延迟
2. 检查账号是否被限制
3. 确认内容是否符合平台规范

#### Q5: MCP客户端连接失败
**解决方案**:
```bash
# 检查服务是否正常运行
curl http://localhost:18060/mcp

# 确认端口没有被占用
lsof -i :18060
```

#### Q6: Python环境相关问题
**Q**: 如何确认Python虚拟环境是否正确创建？
**解决方案**:
```bash
# 检查虚拟环境目录是否存在
ls -la qwen_env/

# 激活虚拟环境并检查Python路径
source qwen_env/bin/activate
which python
python --version

# 检查已安装的包
pip list | grep dashscope
pip list | grep requests
```

**Q**: Windows系统如何激活虚拟环境？
**解决方案**:
```cmd
# Windows命令提示符
qwen_env\Scripts\activate

# Windows PowerShell
qwen_env\Scripts\Activate.ps1
```

**Q**: 虚拟环境中的Python路径在哪里？
**解决方案**:
- **Linux/macOS**: `/path/to/xiaohongshu-mcp/qwen_env/bin/python`
- **Windows**: `C:\path\to\xiaohongshu-mcp\qwen_env\Scripts\python.exe`

### 性能优化建议

1. **批量图片生成**: 建议每次生成间隔2-3秒，避免API限制
2. **内存管理**: 长时间运行建议定期重启服务
3. **网络优化**: 使用稳定的网络环境，避免代理干扰
4. **浏览器优化**: 定期清理浏览器缓存，保持最新版本

### 日志调试

```bash
# 启用详细日志
go run . -headless=false  # 有界面模式便于调试

# 查看Python服务日志
python3 run_qwen_mcp.py 2>&1 | tee qwen.log
```

## AI 图片生成配置

### Python 依赖安装
```bash
# 安装阿里云 DashScope SDK
pip install dashscope requests

# 设置环境变量
export DASHSCOPE_API_KEY="your-api-key"
```

### Qwen 图片生成 MCP 服务使用
```bash
# 启动独立 MCP 服务
python3 run_qwen_mcp.py

# 或在 Claude Code 中通过 MCP 工具调用
"使用 generate_image 工具生成一张小红书风格的美食图片：精致的下午茶摆盘"
```

### 支持的图片风格
- **general**: 通用高质量图片
- **lifestyle**: 生活方式，ins风格
- **food**: 美食摄影，精致摆盘
- **fashion**: 时尚摄影，现代穿搭
- **travel**: 旅行摄影，风景如画
- **beauty**: 美妆护肤，清新自然
- **tech**: 科技产品，现代简约
- **art**: 艺术创作，创意构图
- **traditional**: 中国传统文化，古典雅致
- **business**: 商务场景，专业正式
- **nature**: 自然景观，生态环境
- **portrait**: 人物肖像，情感表达
- **abstract**: 抽象艺术，概念表达
- **cartoon**: 卡通动漫，可爱风格

### 支持的图片尺寸
- **1328*1328**: 1:1 正方形（通用）
- **1664*928**: 16:9 横屏（适合宽屏展示）
- **1472*1140**: 4:3 标准（小红书推荐）
- **1140*1472**: 3:4 竖屏（人像推荐）
- **928*1664**: 9:16 竖屏（短视频平台）

## 扩展能力

系统采用模块化设计，可以轻松扩展：
- 新增其他内容类型（视频、文字）
- 添加更多互动功能
- 集成其他平台
- 集成更多 AI 图片生成服务
- 增加数据分析功能

## 总结

xiaohongshu-mcp 是一个功能完整、技术先进的小红书自动化发布系统，通过 MCP 协议与 Claude Code 无缝集成，为用户提供高效、智能的内容发布解决方案。

**核心优势**：
1. **完整自动化流程**: 从 AI 生成图片到自动发布，实现真正的一站式解决方案
2. **独立 MCP 服务**: Qwen 图片生成服务符合 MCP 协议标准，无预设参数，完全参数化
3. **智能图片生成**: 14种风格、5种尺寸，满足不同场景需求
4. **平台优化**: 针对小红书特性深度优化
5. **技术先进**: Go + Python MCP 服务架构，性能与灵活性兼顾
6. **易于扩展**: 模块化设计，便于功能扩展和定制

系统特别适合内容创作者、社交媒体运营者和个人博主使用，能够显著提升内容发布效率和质量。

## 版本信息

### 当前版本: v2.0.0

#### 主要特性
- ✅ 完整的小红书自动发布功能
- ✅ 独立的Qwen图片生成MCP服务
- ✅ 标准MCP协议支持
- ✅ 多平台兼容性

#### 更新日志

**v2.0.0** (2024-09-18)
- 🎉 重构图片生成服务为标准MCP服务
- ✨ 新增4个图片生成相关MCP工具
- 🔧 优化参数化配置，移除硬编码预设
- 📝 完善文档和使用示例
- 🐛 修复编号错误和重复内容

**v1.0.0** (2024-09-01)
- 🎉 初始版本发布
- ✨ 实现小红书基础发布功能
- ✨ 集成阿里云Qwen图片生成
- ✨ 支持MCP协议
- 📱 支持Claude Code等AI客户端

### 路线图

#### v2.1.0 (计划中)
- 🔮 支持视频内容发布
- 🔮 增加内容模板管理
- 🔮 优化图片批量处理
- 🔮 增加数据统计功能

#### v3.0.0 (规划中)
- 🔮 支持多账号管理
- 🔮 集成更多图片生成服务
- 🔮 支持其他社交平台
- 🔮 Web管理界面

## 贡献指南

### 开发参与
欢迎提交Issue和Pull Request！

1. **提交Issue**: 报告bug或提出新功能建议
2. **代码贡献**: Fork项目并提交PR
3. **文档改进**: 帮助完善文档和示例

### 开发规范
- Go代码遵循 `gofmt` 格式化
- Python代码遵循 PEP 8 规范
- 提交信息使用中文，格式清晰
- 测试覆盖新增功能

## 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件

## 联系方式

- 项目地址: https://github.com/your-org/xiaohongshu-mcp
- 问题反馈: https://github.com/your-org/xiaohongshu-mcp/issues
- 邮箱: your-email@example.com

---

*最后更新: 2024-09-18*